#include <opencv2/opencv.hpp>
#include <iostream>
#include <vector>

using namespace cv;
using namespace std;

// -------------------------- Global variables --------------------------
Mat src, mask, result;
vector<Point> points;
bool drawing = false;

// -------------------------- Mouse callback ----------------------------
void mouseHandler(int event, int x, int y, int, void*) {
    if (event == EVENT_LBUTTONDOWN) {
        points.push_back(Point(x, y));
        circle(src, Point(x, y), 3, Scalar(0, 0, 255), FILLED);
        imshow("Source", src);
    }
    else if (event == EVENT_RBUTTONDOWN && !points.empty()) {
        mask = Mat::zeros(src.size(), CV_8UC1);
        const Point* pts[1] = { &points[0] };
        int npts[] = { (int)points.size() };
        fillPoly(mask, pts, npts, 1, Scalar(255));
        bitwise_and(src, src, result, mask);
        imshow("Mask", mask);
        imshow("Result", result);
    }
    else if (event == EVENT_MBUTTONDOWN) {
        // Reset
        points.clear();
        src.copyTo(result);
        mask = Mat::zeros(src.size(), CV_8UC1);
        imshow("Source", src);
        imshow("Mask", mask);
        imshow("Result", result);
    }
}

// -------------------------- Load input -------------------------------
bool loadInput(const string& filename) {
    src = imread(filename);
    if (src.empty()) {
        cerr << "Cannot load image: " << filename << endl;
        return false;
    }
    src.copyTo(result);
    mask = Mat::zeros(src.size(), CV_8UC1);
    return true;
}

// -------------------------- Export output -----------------------------
void ExportOutput(const string& maskFile, const string& resultFile) {
    imwrite(maskFile, mask);
    imwrite(resultFile, result);
    cout << "Saved mask to: " << maskFile << endl;
    cout << "Saved result to: " << resultFile << endl;
}

// -------------------------- Main --------------------------------------
int main(int argc, char** argv) {
    string filename = (argc > 1) ? argv[1] : "lena.jpg";

    if (!loadInput(filename))
        return -1;

    namedWindow("Source");
    namedWindow("Mask");
    namedWindow("Result");

    setMouseCallback("Source", mouseHandler, nullptr);

    imshow("Source", src);
    imshow("Mask", mask);
    imshow("Result", result);

    cout << "Instructions:\n";
    cout << "Left click - add points\n";
    cout << "Right click - create mask\n";
    cout << "Middle click - reset\n";
    cout << "Press 's' to save output and exit\n";

    while (true) {
        char key = (char)waitKey(0);
        if (key == 's') {
            ExportOutput("mask_output.png", "result_output.png");
            break;
        }
    }

    destroyAllWindows();
    return 0;
}
